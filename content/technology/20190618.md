---
title: Vue SPA å‰ç«¯é‰´æƒ
date: 2019-06-18 19:30:54
author: George
authorTwitter: GeorgeBornAgain
cover: covers/20190618-vue-spa.jpg
tags: [Vue, SPA, ç”¨æˆ·é‰´æƒ]
keywords: [Vue, SPA, é‰´æƒï¼Œè®¤è¯]
description: éšç€å›½å†…è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¼€å§‹é‡‡ç”¨ Vue æ¥å¼€å‘ SPAï¼ŒåŸå‰åç«¯è€¦åˆçš„æ¨¡å¼ï¼Œç”¨æˆ·æƒé™ç­‰é€»è¾‘éƒ½ç”±åç«¯æ¥æ§åˆ¶ï¼Œä½†æ˜¯é‡‡ç”¨ SPA åï¼Œéœ€è¦å‰åç«¯ä¸€èµ·å®ç°é‰´æƒç­–ç•¥ã€‚
showFullContent: false
readingTime: false
---

# æ‰€éœ€å·¥å…·

* Vue Cli 3.*
* Node

# å®‰è£…æ‰€éœ€å·¥å…·

## å®‰è£… Node ç¯å¢ƒ

å‰å¾€ [Node å®˜ç½‘](https://nodejs.org/en/)ä¸‹è½½

## å®‰è£… Vue Cli

```bash
npm install -g @vue/cli
# OR
yarn global add @vue/cli
```
å®‰è£…å®Œæˆåï¼Œéœ€è¦åˆ°

# åˆ›å»ºé¡¹ç›®

```bash
vue create YOUR_PROJECT_NAME
# OR
vue ui
```

```bash
George-2:Node George$ vue create spa


Vue CLI v3.8.2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Update available: 3.8.4  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
? Please pick a preset: default (babel, eslint)


Vue CLI v3.8.2
âœ¨  Creating project in /Users/George/Develop/Node/spa.
ğŸ—ƒ  Initializing git repository...
âš™  Installing CLI plugins. This might take a while...

yarn install v1.13.0
info No lockfile found.
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...
success Saved lockfile.
âœ¨  Done in 207.89s.
ğŸš€  Invoking generators...
ğŸ“¦  Installing additional dependencies...

yarn install v1.13.0
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...

success Saved lockfile.
âœ¨  Done in 53.93s.
âš“  Running completion hooks...

ğŸ“„  Generating README.md...

ğŸ‰  Successfully created project spa.
ğŸ‘‰  Get started with the following commands:

 $ cd spa
 $ yarn serve

George-2:Node George$ 
```

## å®‰è£…ä¾èµ–

```bash
vue add router
vue add vuex
vue add axios
```
ä¸Šé¢åˆ†åˆ«ä¸ºé¡¹ç›®æ·»åŠ äº† vue-routerã€vuexã€axios ä¾èµ–ã€‚

![é¡¹ç›®ç›®å½•ç»“æ„](/article/vue-spa-directory-structure.png)

# é¡¹ç›®å®ç°

## ç”¨æˆ·çŠ¶æ€ç®¡ç†

å› ä¸ºç”¨æˆ·å¯èƒ½æœ‰ä¸¤ç§çŠ¶æ€ï¼Œä¸€ç§æ˜¯å·²ç™»é™†ä¸€ç§æ˜¯æœªç™»é™†ï¼Œé‚£ä¹ˆå‰ç«¯å¦‚ä½•æ¥ä¿å­˜ç”¨æˆ·ç™»é™†çŠ¶æ€å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥ä½¿ç”¨ Vuex æ¥è¿›è¡Œå­˜å‚¨ã€‚ä½†æ˜¯åªæœ‰ Vuex æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå½“ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨åï¼ŒVue æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå°±é‡æ–°åŠ è½½äº†ï¼Œæ‰€ä»¥è¿˜è¦é…åˆæµè§ˆå™¨æä¾›çš„ `Local Storage` æˆ– `Session Storage` æ¥ä¿è¯ç”¨æˆ·åˆ·æ–°è€Œä¸ä¸¢å¤±ç”¨æˆ·çŠ¶æ€ã€‚

```javascript store.js
import Vue from 'vue'
import Vuex from 'vuex'


Vue.use(Vuex);

export default new Vuex.Store({
  state: {
    access_token: localStorage.getItem('access_token'),
  },
  mutations: {
    SET_ACCESS_TOKEN: (state, data) => {
      if(data === false) {
        Vue.set(state, 'access_token', '');
        localStorage.removeItem('access_token');
      } else {
        Vue.set(state, 'access_token', data.access_token);
        localStorage.setItem('access_token', data.access_token);
      }
    }
  },
  actions: {
    signIn({commit}, params) {
      return new Promise((resolve,reject) => {
        Vue.axios.post('/signin', params).then(res => {
          commit('SET_ACCESS_TOKEN', res.data);
          resolve(res);
        }).catch(err => {
          reject(err);
        })
      });
    }
  }
});
```

## ç³»ç»ŸçŠ¶æ€ç®¡ç†
åœ¨å…¨å±€ä¿å­˜ `Layout` çš„ä¿¡æ¯
```javascript store/modules/system.js
import Vue from 'vue'
import api from '../../apis'
import * as types from '../types'

export default {
  state: {
    layout: {
      current: "guest"
    },
    menu: {
      active: "/"
    },
    installed: false,
    version: ""
  },
  mutations: {
    SET_SYSTEM: (state, data) => {
      Vue.set(state, 'installed', data.installed);
      Vue.set(state, 'version', data.version);
    },
    SET_MENU_ACTIVE: (state, data) => {
      Vue.set(state.menu, 'active', data)
    },
    SET_LAYOUT_CURRENT: (state, data) => {
      Vue.set(state.layout, 'current', data)
    }
  },
  actions: {
    fetchSystem({ commit }) {
      api.system.fetch().then(response => {
        commit(types.SET_SYSTEM, response.data)
      });
    }
  }
}

```

## è¯·æ±‚401æ‹¦æˆª

```javascript plugins/axios.js
"use strict";

import Vue from 'vue';
import axios from 'axios'
import store from '../store'
import router from '../router'

// Full config:  https://github.com/axios/axios#request-config
// axios.defaults.baseURL = process.env.baseURL || process.env.apiUrl || '';
// axios.defaults.headers.common['Authorization'] = AUTH_TOKEN;
// axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';

let config = {
  baseURL: process.env.baseURL || process.env.apiUrl || "",
  timeout: 60 * 1000, // Timeout
  withCredentials: true, // Check cross-site Access-Control
};

const request = axios.create(config);

// å®šä¹‰è¯·æ±‚æ‹¦æˆªå™¨
request.interceptors.request.use(config => {
  // éå†è¯·æ±‚å‚æ•°
  for(let key in config.params) {
    // å¦‚æœå‚æ•°çš„å€¼ä¸ºç©ºï¼Œåˆ™åˆ é™¤è¿™ä¸ª Key
    if (config.params.hasOwnProperty(key) && (config.params[key] === "" || config.params[key] === null)) {
      delete config.params[key];
    }
  }
  // å¦‚æœæœ‰ç”¨æˆ·çš„ access token åˆ™åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸Š
  if (store.state.account.access_token) {
    config.headers.Authorization = `Bearer ${store.state.account.access_token}`;
  }
  return config;
}, error => {
  return Promise.reject(error);
});

// å®šä¹‰å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  response => {
    return response.data;
  },
  error => {
    // å¦‚æœçŠ¶æ€ç ä¸º 401 åˆ™æ¸…ç©º Vuex ä¸­çš„çŠ¶æ€ï¼Œå¹¶è·³è½¬åˆ°ç™»é™†é¡µé¢
    if (error.response.status === 401) {
      store.commit('SET_PROFILE', false);
      store.commit('SET_ACCESS_TOKEN', false);
      router.push("/signin");
    }
    return Promise.reject(error.response);
  }
);

Plugin.install = function(Vue) {
  Vue.axios = request;
  window.axios = request;
  Object.defineProperties(Vue.prototype, {
    axios: {
      get() {
        return request;
      }
    },
    $axios: {
      get() {
        return request;
      }
    },
  });
};

Vue.use(Plugin);

export default Plugin;
```

## å‰ç«¯è·¯ç”±æ‹¦æˆª

ä»…ä»…å®ç°äº†API 401çŠ¶æ€ç æ‹¦æˆªè¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦å¯¹å‰ç«¯è·¯ç”±åšå“åº”çš„é‰´æƒã€‚

```javascript router/index.js
import Vue from 'vue'
import store from '../store'
import Router from 'vue-router'

Vue.use(Router);

const router = new Router({
  mode: 'history',
  base: process.env.BASE_URL,
  routes: [
    {
      path: '/',
      name: 'dashboard',
      meta: {
        requiresAuth: true
      },
      component: () => import('../views/Dashboard.vue'),
    },
    {
      path: '/signin',
      name: 'signin',
      meta: {
        requiresAuth: false
      },
      component: () => import('../views/SignIn.vue')
    },
    {
      // ä¼šåŒ¹é…æ‰€æœ‰è·¯å¾„
      path: '*',
      name: "notfound",
      meta: {
        requiresAuth: false
      },
      component: () => import('../views/NotFound.vue')
    }
  ]
});

/**
 * Routing to intercept
 */
router.beforeEach((to, from, next) => {
  // å¦‚æœè·³è½¬åˆ°NotFoundé¡µé¢åˆ™æå‰è®¾ç½®è§†å›¾çš„Layout ä¸º guest
  if (to.name === 'notfound') {
    store.commit('SET_LAYOUT_CURRENT', 'guest');
  }

  // å¦‚æœä»NotFound é¡µé¢è¿”å›ï¼Œå¹¶ä¸”éœ€è¦è®¤è¯çš„è¯ï¼Œåˆ™è®¾ç½®è§†å›¾çš„Layout ä¸º backend
  if (from.name === 'notfound' && to.meta.requiresAuth === true) {
    store.commit('SET_LAYOUT_CURRENT', 'backend')
  }

  // å½“ç”¨æˆ·çš„ access token å­˜åœ¨ä¸”æœ‰æ•ˆï¼Œå‰å¾€çš„è·¯ç”±æ˜¯ ç™»é™†é¡µé¢æ—¶ï¼Œç›´æ¥è·³è½¬åˆ°é¦–é¡µ
  if (store.state.account.access_token && to.path === '/signin') {
    next({
      path: "/"
    })
  }

  /**
   * è·¯ç”±é‰´æƒä¸»è¦é€»è¾‘
   */
  if (to.matched.some(record => record.meta.requiresAuth)) {
    const access_token = store.state.account.access_token;
    //é€šè¿‡access_tokenåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•
    if (!access_token) {
      next({
        path: '/signin'
      })
    } else {
      next()
    }
  } else {
    next()
  }
});

export default router;
```
## é¡µé¢å¸ƒå±€

ç”±äº`ç™»é™†é¡µé¢`å’Œ`åå°é¡µé¢`çš„å¸ƒå±€ä¸åŒæ‰€ä»¥æ²¡æ³•æœç”¨ï¼Œä¸ºäº†åœ¨ç™»é™†åè·³è½¬è·¯ç”±ä¸é‡æ–°æ¸²æŸ“å…¬å…±æ¨¡å—ï¼Œå¦‚èœå•ã€é¡¶éƒ¨å¯¼èˆªæ¡ç­‰ç»„ä»¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨ `App.vue` ä¸­å®ç°æ ¹æ®ç”¨æˆ·ç™»é™†çŠ¶æ€åŠ¨æ€åˆ‡æ¢é¡µé¢å¸ƒå±€çš„é€»è¾‘ã€‚

```vue App.vue
<template>
  <div id="app">
    <component :is="layout.current"></component>
  </div>
</template>

<script>
  import {mapState} from 'vuex'
  import Guest from './layouts/Guest'
  import Backend from './layouts/Backend'

  export default {
    name: 'app',
    data() {
      return {
      }
    },
    methods: {},
    components: {
      guest: Guest,
      backend: Backend
    },
    computed: {
      ...mapState({
        layout: state => state.system.layout,
        profile: state => state.account.profile,
        access_token: state => state.account.access_token
      })
    },
    watch: {
      // Watch ç”¨æˆ·ä¿¡æ¯å˜æ›´ï¼Œåˆ‡æ¢é¡µé¢å¸ƒå±€
      profile(value) {
        if (value.id === '') {
          this.$store.commit('SET_LAYOUT_CURRENT', 'guest');
        } else {
          this.$store.commit('SET_LAYOUT_CURRENT', 'backend');
        }
      },
      /**
       * å½“access_tokençš„stateå‘ç”Ÿå˜åŒ–æ—¶
       * è¯´æ˜ç”¨æˆ·ç™»å½•ä¿¡æ¯éªŒè¯æˆåŠŸï¼Œå¹¶ä¸”æ‹¿åˆ°äº†access_token
       * æ­¤æ—¶è°ƒç”¨fetchProfile è¿™ä¸ªaction è·å–ç”¨æˆ·ä¿¡æ¯
       */
      access_token(value) {
        if (value == null) {
          window.console.log(value);
        }
      },
      '$route' (to, from) {
        if (from.path === '/' && to.name === 'notfound') {
          this.$store.commit('SET_LAYOUT_CURRENT', 'guest');
        }

        if (from.path === '/') {
          if (to.name !== 'notfound') {
            this.$store.commit('SET_LAYOUT_CURRENT', 'backend');
          }
        }

        if (to.name === 'signin') {
          this.$store.commit('SET_LAYOUT_CURRENT', 'guest');
        }

        if (from.name === 'notfound') {
          this.$store.commit('SET_MENU_ACTIVE', to.path);
        }

        this.$store.commit('SET_MENU_ACTIVE', to.path);
      }
    }
  }
</script>

<style lang="scss">

</style>
```

åˆ°æ­¤åŸºæœ¬ä¸Šå‰ç«¯æœ‰å…³ç”¨æˆ·é‰´æƒçš„é€»è¾‘éƒ½å·²ç»å®ç°ï¼Œå‰©ä¸‹çš„åªè¦ä¸“å¿ƒçš„å»å†™ä¸šåŠ¡é€»è¾‘å³å¯ï¼

I hope this is helpful, Happy hacking...