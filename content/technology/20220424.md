---
title: 通过配置 Git Proxy 加速克隆 Github 项目
date: 2022-04-24T22:22:51+08:00
author: George
authorTwitter: GeorgeBornAgain
cover: covers/20220424-git-proxy-config.jpg
tags: [Git, Proxy]
keywords: [Git, Proxy, Github, Clone]
description: 一直以为设置了 ALL_PROXY 环境变量就能让 git clone 走代理，今天通过 SSH 进行 clone 才发现速度巨慢。
showFullContent: false
readingTime: false
draft: false
---

# 前言

可能是之前无论是 NPM 还是 Composer 又或者是 Homebrew 在安装所需要的包时，我都会通过环境变量设置代理，来提升下载的速度。我潜意识里就觉得 `ALL_PROXY` 这个环境变量可能是所有协议都会用这个代理。

但是当我使用 `git clone u-boot/u-boot`  克隆项目时，我发现很长时间并没有任何反应，再一看 Surge 的流量监控，没有流量经过，那应该是没有走我设置的 `ALL_PROXY`。

经过一番面向搜索引擎学习，发现 Git 支持的协议有下面三种：

* HTTP
* SSH
* Git Protocol

# 误区

看到网上很多的教程都说的是在 `~/.gitconfig` 文件中配置 http 和 https 的代理：
```
[http "https://github.com/"]
    proxy = http://<host>:<port>/
[https "https://github.com/"]
    proxy = https://<host>:<port>/
```
又或者是通过下面的命令设置代理：

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ >}}
git config --global http.proxy http://username:password@proxy.server.com:8080
git config --global https.proxy http://username:password@proxy.server.com:8080
{{< /prismjs >}}

或者是像我之前使用的使用临时环境变量：

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ >}}
export https_proxy=http://127.0.0.1:8234;export http_proxy=http://127.0.0.1:8234;export all_proxy=socks5://127.0.0.1:8235
{{< /prismjs >}}

> 注意：这种方式只针对使用 HTTP 协议的才有效！如果你在 clone 的时候使用的是 SSH 协议，这些设置并不能起到什么作用。

# 配置 SSH 代理

与在之前的《[使用 ClashX 为 SSH 加速]({{< ref "/technology/20220215" >}})》文中一样，我们只需要在 `~/.ssh/config` 文件中添加如下配置：

```
Host github.com
    User git
    ProxyCommand nc -x 127.0.0.1:8235 -X 5 %h %p
```

设置好以后，就可以测试使用 SSH 的方式从 Github 上克隆项目了。

对于使用 `gh` [^1] 的开发者来说，如果使用的是 SSH 协议，那么也是一样的。

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ >}}
gh repo clone u-boot/u-boot
{{< /prismjs >}}

![Github CLI clone](/article/20220424-github-cli-clone.png)
![iTerm 2 tasks](/article/20220424-github-cli-clone-tasks.png)

# Git Protocol

本来没打算写关于 Git Protocol 的部分，因为很少用单，但是在学习操作系统的时候需要安装 `riscv-tools`，于是照着 [6.S081: Operating System Engineering](https://pdos.csail.mit.edu/6.828/2019/tools.html) 的步骤安装，但是发现在克隆 `glibc` 的源码时因为网络原因，卡主不动了。看了下日志，这个项目仓库的地址是 `git://sourceware.org/git/glibc.git`。

期初没认出来这个是 Git Protocol，我按照 SSH 的方法在配置文件中设置了 `sourceware.org` 的代理，但是发现并没有生效，然后琢磨了半天，发现这个不是 SSH 协议。

既然找到问题了，那就好解决了，首先需要创建一个 `git-proxy` 脚本：

```bash
#! /bin/bash

# connect to the Git repository through a SOCKS proxy


# default setting is to use port 1080 on the local host
proxy="localhost:1080"
from="default"

# check if there is a value in the git configuration
if git config --get socks.proxy >& /dev/null; then
    proxy=`git config --get socks.proxy`
    from="git's socks.proxy"
fi

# check if a generic proxy has been defined in the environment
if [ -n "$ALL_PROXY" ]; then
    proxy="$ALL_PROXY"
    from="\$ALL_PROXY"
fi
if [ -n "$all_proxy" ]; then
    proxy="$all_proxy"
    from="\$all_proxy"
fi

# check if a SOCKS proxy has been defined in the environment
if [ -n "$SOCKS_PROXY" ]; then
    proxy="$SOCKS_PROXY"
    from="\$SOCKS_PROXY"
fi
if [ -n "$socks_proxy" ]; then
    proxy="$socks_proxy"
    from="\$socks_proxy"
fi
if [ -n "$SOCKS5_PROXY" ]; then
    proxy="$SOCKS5_PROXY"
    from="\$SOCKS5_PROXY"
fi
if [ -n "$socks5_proxy" ]; then
    proxy="$socks5_proxy"
    from="\$socks5_proxy"
fi

# check if a git specific SOCKS proxy has been defined in the environment
if [ -n "$GIT_SOCKS_PROXY" ]; then
    proxy="$GIT_SOCKS_PROXY"
    from="\$GIT_SOCKS_PROXY"
fi

function usage() {
cat << @EOF
Usage:
  `basename $0` HOST PORT

Helper script to connect to a Git repository over the git:// protocol at host HOST and port PORT through a SOCKS proxy at $proxy ($from).

To use the proxy for all git:// traffic, set the core.gitproxy option to "git-proxy":

  git config core.gitproxy "git-proxy"


To use the proxy only for some reporitories, use the syntax explained in git-config(1).

To configure which proxy to use, set an appropriate environment variable (see below) or socks.proxy option to the proxy address, for example "localhost:1080":

  git config socks.proxy "localhost:1080"


The address of the proxy is read from (in order of priority):
  - the GIT_SOCKS_PROXY environment variable;
  - the SOCKS_PROXY or SOCKS5_PROXY environment variable;
  - the ALL_PROXY environment variable (see curl(1));
  - the socks.proxy git option;
  - the default value: localhost:1080 .
@EOF
}

if [ -z "$1" ] || [ -z "$2" ] || [ -n "$3" ]; then
  usage
  exit 1
fi

# connect through the specifid proxy

nc -x "$proxy" "$1" "$2"
```

将上面的代码保存为脚本，然后保存到你的任意 PATH 目录中，例如我这里是放在了 `/usr/local/bin/` 的目录中，命名为：`git-proxy`，然后执行如下命令，验证是否生效：

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ output="2-25" >}}
git-proxy --help

Usage:
  git-proxy HOST PORT

Helper script to connect to a Git repository over the git:// protocol at host HOST and port PORT through a SOCKS proxy at 127.0.0.1:8235 (git's socks.proxy).

To use the proxy for all git:// traffic, set the core.gitproxy option to "git-proxy":

  git config core.gitproxy "git-proxy"


To use the proxy only for some reporitories, use the syntax explained in git-config(1).

To configure which proxy to use, set an appropriate environment variable (see below) or socks.proxy option to the proxy address, for example "localhost:1080":

  git config socks.proxy "localhost:1080"


The address of the proxy is read from (in order of priority):
  - the GIT_SOCKS_PROXY environment variable;
  - the SOCKS_PROXY or SOCKS5_PROXY environment variable;
  - the ALL_PROXY environment variable (see curl(1));
  - the socks.proxy git option;
  - the default value: localhost:1080 .
{{< /prismjs >}}

接着按照提示执行如下命令：

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ >}}
git config core.gitproxy "git-proxy"
git config socks.proxy "127.0.0.1:8235"
{{< /prismjs >}}

另外因为 Surge 的 `Copy Shell Export Command` 生成的命令中，存在 `export all_proxy=socks5://127.0.0.1:8235` 这个环境变量，根据 `git-proxy` 中的脚本逻辑，可以看到如果设置了 `all_proxy` 环境变量，将会覆盖掉 Git 的全局配置！！！正式因为这样，才导致我发现了下面的坑。

> 注意：这里的代理地址不需要加协议类型，直接是 HOST:PORT 这种写法。如过包含协议，如 socks5://127.0.0.1:8235，这种写法会导致 nc: getaddrinfo: nodename nor servname provided, or not known. 从而无法代理 Git Protocol。

I hope this is helpful, Happy hacking...

[^1]: [Github CLI](https://cli.github.com/).