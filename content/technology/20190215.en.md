---
title: Managing Service Configuration
date: 2019-02-15 17:15:56
author: George
authorTwitter: GeorgeBornAgain
cover: covers/20190215-config-manage.jpg
tags: [Confd, Config, Config Manager]
keywords: [Configration, Servers, confd, Consul]
description: As systems become more complex and configuration items increase, configuration management becomes cumbersome on one hand, and redeploying after configuration changes becomes equally painful on the other. At this point, a centralized configuration management system is needed to provide unified configuration management and automatic distribution of configuration changes for timely effect.
showFullContent: false
readingTime: false
---

## Overview

If you want to dynamically modify service configuration files through a WebUI or API in your business, you can use confd to achieve this. The backend supports the following data types:

* etcd
* consul
* vault
* environment variables
* redis
* zookeeper
* dynamodb
* stackengine
* rancher

This way, we can store configurations in a distributed Key/Value store, and modifying configurations no longer requires SSH to the remote server. Here we use consul as the backend storage because it comes with a UI, which is convenient for practice.

## Consul

```bash Running a consul container
docker run -d \
-p 8500:8500 \
--name consul-master \
consul agent -node=master -datacenter=betterde -bind=0.0.0.0 \
-ui -client=0.0.0.0 -server -bootstrap-expect=1
```

After successful execution, you can access http://localhost:8500 to verify that the service is running properly.

```bash Adding configuration to consul
curl -X PUT -d 'api.betterde.om' http://localhost:8500/v1/kv/nginx/api/domain
```
---

![Result](/article/consul.png)

## confd

[Go to download](https://github.com/kelseyhightower/confd/releases)

### Creating Configuration File Directory

```bash
sudo mkdir -p /etc/confd/{conf.d,templates}
```

### Creating Resource Template

```bash
touch /etc/confd/conf.d/nginx.toml
```

```conf Write the following content
[template]
src = "nginx.conf.tmpl"
dest = "/tmp/nginx.conf"
keys = [
    "/nginx/api/domain",
]

check_cmd = "/usr/local/opt/nginx/bin/nginx -t -c {{.src}}"
reload_cmd = "/usr/local/opt/nginx/bin/nginx -s reload"
```

* src: The template file for service configuration
* dest: The directory for the configuration file generated by confd
* keys: Custom keys
* check_cmd: Command for configuration checking, requires service support (optional)
* reload_cmd: Command for reloading configuration, requires service support (optional)

### Creating Configuration Template

```bash
touch /etc/confd/templates/nginx.conf.tmpl
```

```bash Write the following configuration
user zuber-imac staff;
worker_processes auto;

events {
    worker_connections  1024;
}

http {
    default_type  application/octet-stream;

    sendfile on;
    keepalive_timeout  65;
    client_max_body_size 128M;

    gzip  on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;
    ssi on;

    gzip_types
    application/atom+xml
    application/javascript
    application/json
    application/rss+xml
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/opentype
    image/svg+xml
    image/x-icon
    text/css
    text/plain
    text/x-component;

    server {
        listen 80;
        server_name  {{getv "/nginx/api/domain"}};
        root /var/www/html;
        location / {
            index index.html;
        }
    }
}
```

### Running confd

```bash
./confd -watch -backend consul -node localhost:8500
```

Now if you modify the value of /nginx/api/domain, it will automatically regenerate the nginx configuration file to /tmp/nginx.conf and update nginx's configuration.

I hope this is helpful, Happy hacking...