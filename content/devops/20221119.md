---
title: ä½¿ç”¨ smallstep æ­å»ºç§æœ‰çš„ CA æœåŠ¡å™¨
date: 2022-11-18T14:22:21+08:00
author: George
authorTwitter: GeorgeBornAgain
cover: covers/20221119-deploy-your-own-ca-server.jpg
tags: [CA, smallstep, CFSSL, TLS, HTTPS, x.509]
keywords: [CA, smallstep, CFSSL, TLS, HTTPS, x.509]
description: ä¸ºäº†è®©æœ¬åœ°å¼€å‘ç¯å¢ƒä¸æµ‹è¯•æˆ–ç”Ÿäº§ç¯å¢ƒå°½å¯èƒ½çš„ä¿æŒä¸€è‡´ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°å¼€å‘æ—¶ä¹Ÿé‡‡ç”¨ HTTPS çš„æ–¹å¼è®¿é—®æœåŠ¡ã€‚
showFullContent: false
readingTime: false
draft: false
---

# å‰è¨€

æˆ‘ä»¬çš„ä¸šåŠ¡ç»å¸¸éœ€è¦å†è¿‡ä¸ªé¡¹ç›®ä¸­ä¸ºä¸€ä¸ªèµ„æºç”Ÿæˆä¸€ä¸ª URLï¼Œè€Œå› ä¸ºç¯å¢ƒçš„ä¸€è‡´æ€§é—®é¢˜ï¼Œåœ¨ç”Ÿæˆ URL æ—¶ï¼Œç»å¸¸å‡ºç°åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒç”Ÿæˆçš„æ˜¯ HTTPS åè®®ä¸‹çš„ URLã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æŒ‰å¹´è´­ä¹°çš„è¯ä¹¦ï¼Œéƒ¨ç½²åˆ°äº‘ç«¯ SLB ä¸Šå»ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒæœ¬æ¥éƒ½ç»Ÿä¸€æ˜¯ HTTP åè®®ï¼Œä¹Ÿæ­£æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå¾ˆå¤šé—®é¢˜åœ¨æµ‹è¯•ç¯å¢ƒæµ‹ä¸å‡ºæ¥ï¼Œä½†æ˜¯å‘åˆ°ç”Ÿäº§ç¯å¢ƒåå´æš´éœ²å‡ºæ¥äº†ã€‚åæ¥æ”¹é€ æˆäº†é‡‡ç”¨ Let's Encrypt é¢å‘çš„å…è´¹è¯ä¹¦ï¼

ç°åœ¨ä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å›¢é˜Ÿçš„æˆå‘˜åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒæ¯ä¸ªäººç”¨çš„åŸŸåä¸åŒï¼Œåè®®ä¸åŒï¼Œè¿™å¯¼è‡´æ²Ÿé€šæˆæœ¬çš„å¢åŠ ã€‚

ç°åœ¨æˆ‘ä»¬è¦åšçš„æ˜¯ä½¿ç”¨ä¸€å¥— Docker ç¯å¢ƒå°½å¯èƒ½çš„æ¨¡æ‹Ÿå‡ºç”Ÿäº§ç¯å¢ƒï¼

# æ–¹æ¡ˆè°ƒç ”

ç»è¿‡è°ƒç ”å‘ç°ï¼Œå¼€æºçš„ CA é¡¹ç›®æœ‰å¦‚ä¸‹ï¼š

* [CFSSL](https://github.com/cloudflare/cfssl)
* [Pebble](https://github.com/letsencrypt/pebble)
* [minica](https://github.com/jsha/minica)
* [mkcert](https://github.com/FiloSottile/mkcert)
* [Boulder](https://github.com/letsencrypt/boulder)
* [Step Certificates](https://github.com/smallstep/certificates)

ç»è¿‡åˆæ­¥äº†è§£å’Œä¸Šæ‰‹ä½“éªŒï¼Œå‘ç° Step Certificates çš„æ–‡æ¡£æœ€å…¨é¢ï¼Œç”¨æˆ·ä½“éªŒç›¸å¯¹è¾ƒå¥½ï¼Œåªæ˜¯ä¸Šæ‰‹æœ‰ä¸€å®šéš¾åº¦ï¼Œéœ€è¦å¯¹ X.509 æœ‰ä¸€å®šçš„äº†è§£ã€‚

# å®‰è£…

å»ºè®®åœ¨å¼€å§‹ç›´æ¥å¯ä»¥å…ˆé€šç¯‡é˜…è¯»[å®˜æ–¹æ–‡æ¡£](https://smallstep.com/docs/step-ca/)ï¼Œå½¢æˆçŸ¥è¯†æ¡†æ¶ã€‚ç„¶ååœ¨ç»“åˆå®˜æ–¹çš„ Blog: [*Run your own private CA & ACME server using step-ca*](https://smallstep.com/blog/private-acme-server/)ï¼Œè¿›è¡Œæ“ä½œï¼

## Docker

æˆ‘ä»¬å¦‚æœè¦ç”¨äºå›¢é˜Ÿå†…éƒ¨çš„åŸºç¡€å¼€å‘ç¯å¢ƒæ­å»ºï¼Œå¿…ç„¶è¦åœ¨å®¹å™¨ä¸­è¿›è¡Œä½¿ç”¨ï¼š

{{< prismjs lang=yaml line-numbers=true line="12,14" >}}
services:
  step-ca:
    image: smallstep/step-ca:latest
    labels:
      - traefik.enable=false
    restart: always
    volumes:
      - step-ca:/home/step
    hostname: step-ca
    networks:
      traefik:
        ipv4_address: 10.8.10.254
    extra_hosts:
      - ca.svc.dev:127.0.0.1
    environment:
      - TZ=Asia/Shanghai
      - DOCKER_STEPCA_INIT_NAME=Smallstep
      - DOCKER_STEPCA_INIT_ACME=true
      - DOCKER_STEPCA_INIT_ADDRESS=0.0.0.0:443
      - DOCKER_STEPCA_INIT_PASSWORD=ECkFB7TwcHVPuLhOtKwCIP3J3pNGHarF
      - DOCKER_STEPCA_INIT_DNS_NAMES=ca.svc.dev,acme-v02.api.letsencrypt.org,step-ca
      - DOCKER_STEPCA_INIT_ADMIN_SUBJECT=george@betterde.com
      - DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT=true
    container_name: step-ca

volumes:
  step-ca:
    name: step-ca

networks:
  traefik:
    external: true
{{< /prismjs >}}

é…ç½®è¯´æ˜ï¼š

* 12 è¡Œï¼šä¸ºå®¹å™¨è®¾ç½®ä¸€ä¸ªå›ºå®š IPï¼Œè¿™æ ·ä¾¿äºå…¶ä»–æœåŠ¡çš„è¯·æ±‚
* 14 è¡Œï¼šä¸º HTTPS çš„åŸŸååšæœ¬åœ°æ˜ å°„ï¼Œé¿å…å®¹å™¨çš„è‡ªæ£€å¤±è´¥

> ç›®å‰å‘ç°ï¼Œè™½ç„¶åœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®äº† `DOCKER_STEPCA_INIT_ACME` ä¸º `true`ï¼Œä½†æ˜¯ä¾ç„¶æ— æ³•è‡ªåŠ¨æ³¨å†Œ ACME çš„ Providerï¼Œå½“æœåŠ¡èµ·æ¥åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å®¹å™¨æŒ‚è½½å·ä¸­çš„é…ç½®æ–‡ä»¶ï¼

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ output="3-48" >}}
docker compose up -d
docker compose logs
step-ca  | Generating root certificate... done!
step-ca  | Generating intermediate certificate... done!
step-ca  | 
step-ca  | âœ” Root certificate: /home/step/certs/root_ca.crt
step-ca  | âœ” Root private key: /home/step/secrets/root_ca_key
step-ca  | âœ” Root fingerprint: ab8462fc8e67c581626e829a18f5a801b5eea15baf07ee943a6f2bfa24ee8e40
step-ca  | âœ” Intermediate certificate: /home/step/certs/intermediate_ca.crt
step-ca  | âœ” Intermediate private key: /home/step/secrets/intermediate_ca_key
step-ca  | badger 2024/07/16 06:37:16 INFO: All 0 tables opened in 0s
step-ca  | badger 2024/07/16 06:37:16 INFO: Storing value log head: {Fid:0 Len:30 Offset:3321}
step-ca  | badger 2024/07/16 06:37:16 INFO: [Compactor: 173] Running compaction: {level:0 score:1.73 dropPrefixes:[]} for level: 0
step-ca  | badger 2024/07/16 06:37:16 INFO: LOG Compact 0->1, del 1 tables, add 1 tables, took 5.842993ms
step-ca  | badger 2024/07/16 06:37:16 INFO: [Compactor: 173] Compaction for level: 0 DONE
step-ca  | badger 2024/07/16 06:37:16 INFO: Force compaction on level 0 done
step-ca  | âœ” Database folder: /home/step/db
step-ca  | âœ” Default configuration: /home/step/config/defaults.json
step-ca  | âœ” Certificate Authority configuration: /home/step/config/ca.json
step-ca  | âœ” Admin provisioner: admin (JWK)
step-ca  | âœ” Super admin subject: george@betterde.com
step-ca  | 
step-ca  | Your PKI is ready to go. To generate certificates for individual services see 'step help ca'.
step-ca  | 
step-ca  | FEEDBACK ğŸ˜ ğŸ»
step-ca  |   The step utility is not instrumented for usage statistics. It does not phone
step-ca  |   home. But your feedback is extremely valuable. Any information you can provide
step-ca  |   regarding how youâ€™re using `step` helps. Please send us a sentence or two,
step-ca  |   good or bad at feedback@smallstep.com or join GitHub Discussions
step-ca  |   https://github.com/smallstep/certificates/discussions and our Discord
step-ca  |   https://u.step.sm/discord.
step-ca  | 
step-ca  | ğŸ‘‰ Your CA administrative username is: george@betterde.com
step-ca  | ğŸ‘‰ Your CA administrative password is: ECkFB7TwcHVPuLhOtKwCIP3J3pNGHarF
step-ca  | ğŸ¤« This will only be displayed once.
step-ca  | badger 2024/07/16 06:37:16 INFO: All 1 tables opened in 1ms
step-ca  | badger 2024/07/16 06:37:16 INFO: Replaying file id: 0 at offset: 3351
step-ca  | badger 2024/07/16 06:37:16 INFO: Replay took: 1.708Âµs
step-ca  | 2024/07/16 06:37:16 Building new tls configuration using step-ca x509 Signer Interface
step-ca  | 2024/07/16 06:37:16 Starting Smallstep CA/0.27.1 (linux/arm64)
step-ca  | 2024/07/16 06:37:16 Documentation: https://u.step.sm/docs/ca
step-ca  | 2024/07/16 06:37:16 Community Discord: https://u.step.sm/discord
step-ca  | 2024/07/16 06:37:16 Config file: /home/step/config/ca.json
step-ca  | 2024/07/16 06:37:16 The primary server URL is https://ca.svc.dev:443
step-ca  | 2024/07/16 06:37:16 Root certificates are available at https://ca.svc.dev:443/roots.pem
step-ca  | 2024/07/16 06:37:16 Additional configured hostnames: acme-v02.api.letsencrypt.org, step-ca
step-ca  | 2024/07/16 06:37:16 X.509 Root Fingerprint: ab8462fc8e67c581626e829a18f5a801b5eea15baf07ee943a6f2bfa24ee8e40
step-ca  | 2024/07/16 06:37:16 Serving HTTPS on 0.0.0.0:443 ...
{{< /prismjs >}}

# é…ç½®

å½“å®¹å™¨å¯åŠ¨åï¼ŒSmallstep ä¼šç”Ÿæˆå¯¹åº”çš„é…ç½®ï¼š

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ output="2-20" >}}
tree
.
â”œâ”€â”€ certs
â”‚Â Â  â”œâ”€â”€ intermediate_ca.crt
â”‚Â Â  â””â”€â”€ root_ca.crt
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ ca.json
â”‚Â Â  â””â”€â”€ defaults.json
â”œâ”€â”€ db
â”‚Â Â  â”œâ”€â”€ 000000.vlog
â”‚Â Â  â”œâ”€â”€ 000030.sst
â”‚Â Â  â”œâ”€â”€ KEYREGISTRY
â”‚Â Â  â””â”€â”€ MANIFEST
â”œâ”€â”€ secrets
â”‚Â Â  â”œâ”€â”€ intermediate_ca_key
â”‚Â Â  â”œâ”€â”€ password
â”‚Â Â  â””â”€â”€ root_ca_key
â””â”€â”€ templates

6 directories, 11 files
{{< /prismjs >}}

è¿™å…¶ä¸­æœ€å¸¸ç”¨åˆ°çš„å°±æ˜¯ `certs/root_ca.crt` å’Œ `config/ca.json`ã€‚ä¸‹é¢æ˜¯ `config/ca.json` çš„é…ç½®ï¼š

{{< prismjs lang=json line-numbers=true line="22-34,36-41" >}}
{
  "root": "/home/step/certs/root_ca.crt",
  "federatedRoots": null,
  "crt": "/home/step/certs/intermediate_ca.crt",
  "key": "/home/step/secrets/intermediate_ca_key",
  "address": "0.0.0.0:443",
  "insecureAddress": "",
  "dnsNames": [
    "ca.svc.dev",
    "acme-v02.api.letsencrypt.org",
    "step-ca"
  ],
  "logger": {
    "format": "text"
  },
  "db": {
    "type": "badgerv2",
    "dataSource": "/home/step/db",
    "badgerFileLoadingMode": ""
  },
  "authority": {
    "claims": {
      "disableRenewal": false,
      "minTLSCertDuration": "2160h",
      "maxTLSCertDuration": "2160h",
      "defaultTLSCertDuration": "2160h",
      "allowRenewalAfterExpiry": false,
      "minHostSSHCertDuration": "5m",
      "maxHostSSHCertDuration": "1680h",
      "minUserSSHCertDuration": "5m",
      "maxUserSSHCertDuration": "24h",
      "defaultUserSSHCertDuration": "16h",
      "defaultHostSSHCertDuration": "720h"
    },
    "enableAdmin": true,
    "provisioners": [
      {
        "type": "ACME",
        "name": "acme"
      }
    ]
  },
  "tls": {
    "cipherSuites": [
      "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256",
      "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
    ],
    "minVersion": 1.2,
    "maxVersion": 1.3,
    "renegotiation": false
  }
}
{{< /prismjs >}}

é…ç½®è¯´æ˜ï¼š

* 22~24 è¡Œçš„ `claims` éƒ¨åˆ†æ˜¯æ‰‹åŠ¨å¢åŠ çš„é…ç½®ï¼Œä¸»è¦æ˜¯é…ç½®è¯ä¹¦çš„æœ‰æ•ˆæ—¶é•¿ç­‰
* 36~41 è¡Œçš„ `provisioners` éƒ¨åˆ†ç”¨äºå¼€å¯ ACME ç›¸å…³é…ç½®

> è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå®˜æ–¹çš„ Blog ä¸­è¯´è¦å°† `minTLSCertDuration` å’Œ `maxTLSCertDuration`ï¼Œé…ç½®åœ¨ `ACME` Provider å½“ä¸­ï¼Œå®é™…æµ‹è¯•ä¸‹æ¥ï¼Œå¹¶ä¸ç”Ÿæ•ˆï¼

é…ç½®ä¿®æ”¹å¥½ä»¥åï¼Œé‡å¯å®¹å™¨å³å¯ï¼

# å®¿ä¸»æœº

è¦æƒ³åœ¨å®¿ä¸»æœºä¸­ä½¿ç”¨ CAï¼Œåˆ™éœ€è¦å°† CA çš„æ ¹è¯ä¹¦æ·»åŠ åˆ°ç³»ç»Ÿçš„ä¿¡ä»»è¯ä¹¦åˆ—è¡¨ä¸­ã€‚åœ¨ macOS ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¥å®‰è£… Smallstep:

```bash
brew install step
step certificate install <ROOT_CA_PATH>
```

> å°† <ROOT_CA_PATH> éƒ¨åˆ†æ›¿æ¢ä¸ºä½ å®¹å™¨å·ä¸­ `root_ca.crt` è¯ä¹¦çš„æ–‡ä»¶è·¯å¾„ï¼Œç„¶åæ‰§è¡Œå®‰è£…ï¼

å®‰è£…æˆåŠŸåï¼Œç³»ç»Ÿå°±èƒ½å¤Ÿä¿¡ä»»æ‰€æœ‰ç”± Smallstep ç­¾å‘çš„è¯ä¹¦äº†ï¼

# æ‰‹åŠ¨ç”Ÿæˆè¯ä¹¦

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ output="2-7" >}}
docker compose exec step-ca step ca certificate localhost certs/localhost.crt certs/localhost.key
âœ” Provisioner: acme (ACME)
Using Standalone Mode HTTP challenge to validate localhost . done!
Waiting for Order to be 'ready' for finalization .. done!
Finalizing Order .. done!
âœ” Certificate: certs/localhost.crt
âœ” Private Key: certs/localhost.key
{{< /prismjs >}}

> å‘½ä»¤æ‰§è¡Œåï¼Œä¼šæç¤ºä½ é€‰æ‹©ä¸€ä¸ª Providerï¼Œè¿™é‡Œå°±é€‰ ACMEã€‚

ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶åœ¨ `step-ca` å·ä¸­çš„ `certs` ç›®å½•ä¸­ï¼Œå¯ä»¥å°†è¯ä¹¦æ‹·è´åˆ°å®¿ä¸»æœºä¸­ï¼Œç„¶åç”¨ `step CLI` è¿›è¡ŒéªŒè¯:

{{< prismjs lang=bash line-numbers=true command-line=true prompt=$ output="2-42" >}}
step certificate inspect localhost.crt
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 208228708681982736082256753293896422484 (0x9ca763f9fb606e7dfb51d17c15a39454)
    Signature Algorithm: ECDSA-SHA256
        Issuer: O=Smallstep,CN=Smallstep Intermediate CA
        Validity
            Not Before: Jul 18 01:54:16 2024 UTC
            Not After : Oct 16 01:55:16 2024 UTC
        Subject: CN=localhost
        Subject Public Key Info:
            Public Key Algorithm: ECDSA
                Public-Key: (256 bit)
                X:
                    bf:93:74:5a:7d:75:a1:af:68:3d:52:ec:0b:8f:66:
                    09:a7:40:bb:94:93:7c:f8:a0:ad:03:be:e2:ec:51:
                    11:7c
                Y:
                    52:29:b1:c5:a1:c2:0b:c8:97:c3:da:65:1b:36:2a:
                    d9:4f:2d:2f:48:f9:b3:c5:8e:f5:4b:9d:40:35:7e:
                    a4:5e
                Curve: P-256
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature
            X509v3 Extended Key Usage:
                Server Authentication, Client Authentication
            X509v3 Subject Key Identifier:
                3C:E8:3A:68:B4:4A:C2:63:E9:7E:6A:0C:8A:29:F7:2A:CF:38:94:D2
            X509v3 Authority Key Identifier:
                keyid:83:CC:31:DD:68:E3:02:76:25:E1:50:B9:FD:15:59:81:29:6C:EB:96
            X509v3 Subject Alternative Name:
                DNS:localhost
            X509v3 Step Provisioner:
                Type: ACME
                Name: acme
    Signature Algorithm: ECDSA-SHA256
         30:44:02:20:20:95:51:3c:14:72:1e:9c:14:7f:3b:8a:4f:5b:
         e9:4a:24:a1:a4:b1:74:87:dc:20:81:2c:68:b6:d2:5b:d2:b3:
         02:20:7c:19:f0:df:8f:c0:ef:f6:d0:9c:01:69:d0:4a:ca:e1:
         39:d7:67:e7:71:4f:9a:2b:25:2a:79:a6:87:e6:f9:ec
{{< /prismjs >}}

# æ€»ç»“

åˆ°è¿™é‡ŒåŸºäº Smallstep çš„ PKI å°±å·²ç»æ­å»ºå®Œæˆäº†ï¼Œåœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯è¯´æ˜äº†å¦‚ä½•æ‰‹åŠ¨æ¥ç”Ÿæˆè¯ä¹¦ï¼Œå¦‚æœåªæ˜¯æ‰‹åŠ¨ç”Ÿæˆè¯ä¹¦çš„è¯ï¼Œé‚£ä¹ˆ Smallstep ç›¸è¾ƒäºæ–‡ç« å¼€å¤´æåˆ°çš„ä¸€äº› CA CLI å·¥å…·æ¥è¯´ï¼Œå¤æ‚äº†å¾ˆå¤šï¼

ä½†æ˜¯ Smallstep çš„æ ¸å¿ƒæ˜¯å…¶å†…ç½® CA æœåŠ¡å’Œå¯¹ ACME åè®®çš„æ”¯æŒï¼

æ¥ä¸‹æ¥è¿˜æœ‰å¾ˆå¤šéœ€è¦å’Œç°æœ‰å·¥å…·è¿›è¡Œèåˆçš„åœ°æ–¹ï¼Œä¾‹å¦‚ Traefik å¦‚ä½•åˆ©ç”¨ Smallstep å®ç°è‡ªåŠ¨ç”³è¯· HTTPS è¯ä¹¦â€¦â€¦

I hope this is helpful, Happy hacking...